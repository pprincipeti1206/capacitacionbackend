/*
 * Project home: https://github.com/jaxio/celerio-angular-quickstart
 * 
 * Source code generated by Celerio, an Open Source code generator by Jaxio.
 * Documentation: http://www.jaxio.com/documentation/celerio/
 * Modificado por CARLOS BAZALAR
 * Email: cbazalarlarosa@gmail.com
 * Template pack-angular:src/main/java/rest/EntitydeltaResource.java.e.vm
 */
package com.incloud.hcp.rest.delta;

import com.incloud.hcp.domain.MigCertificado;
import com.incloud.hcp.domain.MigCertificadoDetalle;
import com.incloud.hcp.domain.MigLogError;
import com.incloud.hcp.exception.ServiceException;
import com.incloud.hcp.repository.delta.MigCertificadoDeltaRepository;
import com.incloud.hcp.repository.delta.MigLogErrorDeltaRepository;
import com.incloud.hcp.rest.MigCertificadoDetalleRest;
import com.incloud.hcp.util.Utils;
import com.incloud.hcp.utils.DateUtils;
import io.swagger.annotations.ApiOperation;
import org.apache.commons.lang.StringUtils;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.MessageSource;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import java.io.InputStream;
import java.math.BigDecimal;
import java.util.Date;
import java.util.Iterator;

import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE;

@RestController
@RequestMapping("/api/migCertificadoDetalle")
public class MigCertificadoDetalleDeltaRest extends MigCertificadoDetalleRest {

    @Autowired
    protected MessageSource messageSource;

    @Autowired
    private MigCertificadoDeltaRepository migCertificadoDeltaRepository;

    @Autowired
    private MigLogErrorDeltaRepository migLogErrorDeltaRepository;

    @ApiOperation(value = "Inserta registros de MigCertificado en base a un Excel de Carga", produces = "application/json")
    @PostMapping(value = "/uploadExcelMigracion", produces = APPLICATION_JSON_VALUE)
    public String uploadExcelMigracion(@RequestParam("file") MultipartFile file) {
        log.debug(this.NOMBRE_CLASE + " - Ingresando uploadExcel");
        try {
            InputStream in = file.getInputStream();
            log.debug("Ingresando uploadExcelMigracion");
            int inicioRegistroData = 2;

            Date fechaActual = DateUtils.obtenerFechaHoraActual();
            String tablaMigrar = "MIG_CERTIFICADO_DETALLE";
            int contadorExcel = 0;

            Workbook workbook = new XSSFWorkbook(in);
            try {
                Sheet datatypeSheet = workbook.getSheetAt(0);
                Iterator<Row> iterator = datatypeSheet.iterator();
                int contadorRegistro = 1;
                while (iterator.hasNext()) {
                    if (contadorRegistro < inicioRegistroData) {
                        contadorRegistro++;
                        Row currentRow = iterator.next();
                        continue;
                    }
                    try {
                        MigCertificadoDetalle bean = new MigCertificadoDetalle();
                        Row currentRow = iterator.next();
                        Iterator<Cell> cellIterator = currentRow.iterator();
                        boolean error = false;
                        contadorExcel = currentRow.getRowNum() + 1;

                        while (cellIterator.hasNext()) {
                            Cell currentCell = cellIterator.next();
                            bean = this.setUploadExcelMigracion(currentCell, bean, currentCell.getColumnIndex() + 1);
                        }
                        String mensaje = this.validacionesPreviasMigracion(bean);
                        if (StringUtils.isNotBlank(mensaje)) {
                            MigLogError migLogError = new MigLogError();
                            migLogError.setTabla(tablaMigrar);
                            migLogError.setIdRegistro(contadorExcel);
                            migLogError.setFechaCreacion(fechaActual);
                            migLogError.setError("Validaciones: " + mensaje);
                            this.migLogErrorDeltaRepository.save(migLogError);
                        } else {
                            //log.error("Ingresando bean detalle: " + bean.toString());
                            bean = this.migCertificadoDetalleDeltaRepository.save(bean);
                        }
                    }
                    catch (Exception e) {
                        //log.error("Ingresando e: ");
                        //e.printStackTrace();
                        MigLogError migLogError = new MigLogError();
                        migLogError.setTabla(tablaMigrar);
                        migLogError.setIdRegistro(contadorExcel);
                        migLogError.setFechaCreacion(fechaActual);
                        //migLogError.setError("Exception e: " + e.getMessage());
                        this.migLogErrorDeltaRepository.save(migLogError);
                    }

                }
            } catch (Exception exw) {
                //log.error("Ingresando exw: ");
                //exw.printStackTrace();
                MigLogError migLogError = new MigLogError();
                migLogError.setTabla(tablaMigrar);
                migLogError.setIdRegistro(contadorExcel);
                migLogError.setFechaCreacion(fechaActual);
                //migLogError.setError("Exception ewt: " + exw.getMessage());
                this.migLogErrorDeltaRepository.save(migLogError);

            } finally {
                workbook.close();
            }


            return "OK";
        } catch (Exception e) {
            e.printStackTrace();
            String error = Utils.obtieneMensajeErrorExceptionDepurado(e);
            throw new RuntimeException(error);
        }
    }


    private MigCertificadoDetalle setUploadExcelMigracion(Cell currentCell, MigCertificadoDetalle migCertificadoDetalle, int contador) throws Exception {
        Double valorDouble = new Double(0);
        BigDecimal valorDecimal = new BigDecimal(0);
        Integer valorInteger = new Integer(0);
        Boolean valorBoolean = new Boolean(true);
        String valorCadena = "";
        switch (contador) {
            case 1:
                try {
                    valorDouble = currentCell.getNumericCellValue();
                    valorInteger = new Integer(valorDouble.intValue());
                    migCertificadoDetalle.setId(valorInteger);
                } catch (Exception e) {
                    throw new ServiceException("Valor Campo Id está en formato incorrecto");
                }
                break;
            case 2:
                try {
                    valorDouble = currentCell.getNumericCellValue();
                    valorInteger = new Integer(valorDouble.intValue());
                    MigCertificado migCertificado = this.migCertificadoDeltaRepository.getOne(valorInteger);
                    migCertificadoDetalle.setMigCertificado(migCertificado);
                } catch (Exception e) {
                    throw new ServiceException("Valor Campo MigCertificado está en formato incorrecto");
                }
                break;
            case 3:
                try {
                    valorCadena = currentCell.getStringCellValue();
                    if (valorCadena.length() > 10) {
                        throw new ServiceException("Valor Campo posicion contiene mas de 10 caracter(es)");
                    }
                    migCertificadoDetalle.setPosicion(valorCadena);
                } catch (Exception e) {
                    throw new ServiceException("Valor Campo posicion está en formato incorrecto");
                }
                break;
            case 4:
                try {
                    valorCadena = currentCell.getStringCellValue();
                    if (valorCadena.length() > 40) {
                        throw new ServiceException("Valor Campo moneda contiene mas de 40 caracter(es)");
                    }
                    migCertificadoDetalle.setMoneda(valorCadena);
                } catch (Exception e) {
                    throw new ServiceException("Valor Campo moneda está en formato incorrecto");
                }
                break;
            case 5:
                try {
                    valorCadena = currentCell.getStringCellValue();
                    if (valorCadena.length() > 400) {
                        throw new ServiceException("Valor Campo descripcion contiene mas de 400 caracter(es)");
                    }
                    migCertificadoDetalle.setDescripcion(valorCadena);
                } catch (Exception e) {
                    throw new ServiceException("Valor Campo descripcion está en formato incorrecto");
                }
                break;
            case 6:
                try {
                    valorCadena = currentCell.getStringCellValue();
                    if (valorCadena.length() > 40) {
                        throw new ServiceException("Valor Campo unidadMedida contiene mas de 40 caracter(es)");
                    }
                    migCertificadoDetalle.setUnidadMedida(valorCadena);
                } catch (Exception e) {
                    throw new ServiceException("Valor Campo unidadMedida está en formato incorrecto");
                }
                break;
            case 7:
                try {
                    valorCadena = currentCell.getStringCellValue();
                    if (valorCadena.length() > 40) {
                        throw new ServiceException("Valor Campo cuentaContable contiene mas de 40 caracter(es)");
                    }
                    migCertificadoDetalle.setCuentaContable(valorCadena);
                } catch (Exception e) {
                    throw new ServiceException("Valor Campo cuentaContable está en formato incorrecto");
                }
                break;
            case 8:
                try {
                    valorCadena = currentCell.getStringCellValue();
                    if (valorCadena.length() > 40) {
                        throw new ServiceException("Valor Campo ccAfeOrden contiene mas de 40 caracter(es)");
                    }
                    migCertificadoDetalle.setCcAfeOrden(valorCadena);
                } catch (Exception e) {
                    throw new ServiceException("Valor Campo ccAfeOrden está en formato incorrecto");
                }
                break;
            case 9:
                try {
                    valorDecimal = new BigDecimal(currentCell.getNumericCellValue());
                    valorDecimal = valorDecimal.setScale(2, BigDecimal.ROUND_HALF_UP);
                    migCertificadoDetalle.setPrecioUnitario(valorDecimal);
                } catch (Exception e) {
                    throw new ServiceException("Valor Campo precioUnitario está en formato incorrecto");
                }
                break;
            case 10:
                try {
                    valorDecimal = new BigDecimal(currentCell.getNumericCellValue());
                    valorDecimal = valorDecimal.setScale(4, BigDecimal.ROUND_HALF_UP);
                    migCertificadoDetalle.setCantidadEntregada(valorDecimal);
                } catch (Exception e) {
                    throw new ServiceException("Valor Campo cantidadEntregada está en formato incorrecto");
                }
                break;
            case 11:
                try {
                    valorDecimal = new BigDecimal(currentCell.getNumericCellValue());
                    valorDecimal = valorDecimal.setScale(4, BigDecimal.ROUND_HALF_UP);
                    migCertificadoDetalle.setTotalLinea(valorDecimal);
                } catch (Exception e) {
                    throw new ServiceException("Valor Campo totalLinea está en formato incorrecto");
                }
                break;
            case 12:
                try {
                    valorCadena = currentCell.getStringCellValue();
                    if (valorCadena.length() > 500) {
                        throw new ServiceException("Valor Campo hojaServicio contiene mas de 500 caracter(es)");
                    }
                    migCertificadoDetalle.setHojaServicio(valorCadena);
                } catch (Exception e) {
                    throw new ServiceException("Valor Campo hojaServicio está en formato incorrecto");
                }
                break;
            default:
                break;
        }
        return migCertificadoDetalle;
    }

    private String validacionesPreviasMigracion(MigCertificadoDetalle bean) throws Exception {
        String mensaje = "";
        return mensaje;
    }

}
